<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>顔障害物ゲーム</title>
  <style>
    canvas { border: 2px solid black; display: block; margin: 20px auto; }
    video { display: none; } /* 撮影用のビデオは隠す */
  </style>
</head>
<body>
  <h2 style="text-align:center">顔が障害物になる避けゲー</h2>
  <button id="startBtn">顔を撮影してスタート</button>
  <canvas id="gameCanvas" width="600" height="400"></canvas>
  <video id="video" autoplay></video>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const video = document.getElementById("video");
    const startBtn = document.getElementById("startBtn");

    let player = { x: 300, y: 200, size: 20, speed: 4 };
    let obstacle = { x: 100, y: 100, dx: 3, dy: 2, size: 80 };
    let img = new Image();
    let gameRunning = false;

    // キー入力管理
    let keys = {};
    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);

    function updatePlayer() {
      if (keys["w"]) player.y -= player.speed;
      if (keys["s"]) player.y += player.speed;
      if (keys["a"]) player.x -= player.speed;
      if (keys["d"]) player.x += player.speed;
      player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
      player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
    }

    function updateObstacle() {
      obstacle.x += obstacle.dx;
      obstacle.y += obstacle.dy;

      if (obstacle.x <= 0 || obstacle.x + obstacle.size >= canvas.width) {
        obstacle.dx *= -1;
      }
      if (obstacle.y <= 0 || obstacle.y + obstacle.size >= canvas.height) {
        obstacle.dy *= -1;
      }
    }

    function checkCollision() {
      return (
        player.x < obstacle.x + obstacle.size &&
        player.x + player.size > obstacle.x &&
        player.y < obstacle.y + obstacle.size &&
        player.y + player.size > obstacle.y
      );
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // プレイヤー
      ctx.fillStyle = "blue";
      ctx.fillRect(player.x, player.y, player.size, player.size);

      // 障害物（顔画像）
      ctx.drawImage(img, obstacle.x, obstacle.y, obstacle.size, obstacle.size);

      updatePlayer();
      updateObstacle();

      if (checkCollision()) {
        ctx.fillStyle = "red";
        ctx.font = "30px Arial";
        ctx.fillText("GAME OVER", 200, 200);
        return;
      }

      requestAnimationFrame(gameLoop);
    }

    // カメラから顔を撮影 → 障害物に設定
    async function captureFaceAndStart() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      // 撮影してcanvasにコピー
      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");
      tempCanvas.width = 80;
      tempCanvas.height = 80;

      // 1フレーム待ってから描画
      setTimeout(() => {
        tempCtx.drawImage(video, 0, 0, 80, 80);
        img.src = tempCanvas.toDataURL("image/png");
        gameRunning = true;
        gameLoop();
      }, 1000);
    }

    startBtn.onclick = () => {
      captureFaceAndStart();
      startBtn.style.display = "none";
    };
  </script>
</body>
</html>
