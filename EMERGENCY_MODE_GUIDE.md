# 🚨 緊急モード - 使用方法と効果

## 緊急モードとは？

Firestoreの読み取り回数が制限に達した際に、アプリケーションの機能を制限して使用量を最小限に抑えるモードです。

## 有効化方法

`.env`ファイルに以下を追加：

```bash
# 緊急モードを有効化
VITE_EMERGENCY_MODE=true

# 読み取り回数のログを有効化（デバッグ用）
VITE_LOG_FIRESTORE_READS=true
```

設定後、アプリケーションを再起動してください。

## 緊急モード時の変更点

### 🔴 制限される機能

1. **リアルタイム更新の無効化**
   - `onSnapshot`リスナーが無効になります
   - データは手動更新のみで取得

2. **表示件数の大幅制限**
   - 部屋一覧: 20件 → **5件**
   - 参加者表示: 50人 → **10人**

3. **更新間隔の延長**
   - 通常: 1秒 → **5秒**
   - 参加者更新: 0.8秒 → **3秒**

4. **キャッシュ時間の延長**
   - 部屋データ: 1分 → **5分**
   - 参加者データ: 30秒 → **3分**

### 🟡 影響を受ける画面

#### ホーム画面
- ❌ 自動的な部屋一覧更新
- ✅ 手動更新ボタンでの部屋一覧取得
- ⚠️ 最大5部屋まで表示

#### 部屋画面
- ❌ リアルタイム参加者更新
- ❌ 自動的な部屋情報更新
- ✅ 手動更新による参加者確認
- ⚠️ 最大10人まで表示

### 🟢 影響を受けない機能

- ✅ 部屋の作成
- ✅ 部屋への参加・退出
- ✅ ポモドーロタイマー
- ✅ ビデオ通話機能
- ✅ ローカルストレージ

## UI上での表示

### 警告バナー
緊急モードが有効な場合、以下の警告が表示されます：

```
🚨 緊急モードが有効です
- リアルタイム更新が無効 → 手動更新のみ
- 表示件数制限: 部屋5件、参加者10人
- 更新間隔: 5秒以上

💡 解決方法: Firebase Sparkプランをアップグレードするか、
しばらく時間をおいてからアクセスしてください。
```

### 更新ボタンの変更
- **通常時**: 「部屋一覧を更新」
- **緊急時**: 「手動更新（緊急モード）」+ 最終更新時刻表示

## 読み取り回数の削減効果

### 通常モード vs 緊急モード

| 項目 | 通常モード | 緊急モード | 削減率 |
|------|-----------|-----------|--------|
| 部屋一覧読み取り | 継続的 | 手動のみ | **95%** |
| 参加者読み取り | 継続的 | 手動のみ | **95%** |
| 表示件数 | 制限なし | 大幅制限 | **75%** |
| キャッシュ効果 | 標準 | 強化 | **50%** |

**総合削減効果: 約90-95%**

## 使用シナリオ

### 1. 読み取り制限に達した場合
```bash
# 緊急モードを即座に有効化
echo "VITE_EMERGENCY_MODE=true" >> .env
npm run dev
```

### 2. 制限解除後の復旧
```bash
# 緊急モードを無効化
echo "VITE_EMERGENCY_MODE=false" >> .env
# または .env から該当行を削除
npm run dev
```

### 3. 予防的な制限適用
Firebase使用量が80%に達したら予防的に緊急モードを有効化

## 開発者向け情報

### ログ出力例
```
Firestore Read #1: snapshot-rooms
Firestore Read #2: manual-refresh
⚠️ 読み取り回数が10000を超えました: 10001
```

### 設定値のカスタマイズ
`src/config/firestore.js`で制限値を調整可能：

```javascript
EMERGENCY_LIMITS: {
  ROOMS_PER_PAGE: 3,           // さらに厳しく制限
  PARTICIPANTS_PER_ROOM: 5,    // さらに厳しく制限
  REFRESH_DEBOUNCE_MS: 10000,  // 10秒間隔に
  // ...
}
```

## トラブルシューティング

### Q: 緊急モードを有効にしても制限されない
**A:** アプリケーションの再起動が必要です。`npm run dev`を再実行してください。

### Q: 手動更新ボタンが効かない
**A:** ブラウザのコンソールでエラーを確認してください。ネットワーク接続を確認してください。

### Q: 緊急モードを解除したい
**A:** `.env`から`VITE_EMERGENCY_MODE=true`を削除またはfalseに変更して再起動してください。

### Q: 読み取り回数を確認したい
**A:** `VITE_LOG_FIRESTORE_READS=true`を設定してブラウザのコンソールを確認してください。
