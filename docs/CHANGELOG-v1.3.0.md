# 変更履歴 v1.3.0 - ホスト権限の固定化

**日付**: 2025-10-17  
**種類**: 設計変更（Breaking Change）

---

## 📋 変更概要

**ホスト権限の自動移譲を削除し、シンプルな設計に変更**

観測されたバグ（ホスト退出時に権限が正しく移譲されない）を解決するため、
ホスト権限の自動移譲機能を削除し、より予測可能でシンプルな設計に変更しました。

---

## 🎯 設計方針

### **変更前（v1.1.0 - v1.2.0）**
```
❌ ホストが退出 → 次の参加者に自動的に権限移譲
   ↓
   問題: 権限移譲のロジックが複雑でバグが発生
```

### **変更後（v1.3.0）**
```
✅ ホストが退出 → hostId はそのまま保持（権限移譲しない）
   ↓
   結果: シンプルで予測可能な動作
```

---

## 🔧 技術的な変更

### 1. **useParticipants.js の簡略化**

#### 削除したコード:
```javascript
// ❌ 削除: ホスト権限移譲ロジック
if (isCurrentHost) {
  // 残っている参加者を取得
  const remainingParticipantsQuery = query(
    collection(getRoomsCollection(), roomId, "participants"),
    orderBy("joinedAt", "asc"),
    limit(1)
  );
  
  const remainingSnapshot = await getDocs(remainingParticipantsQuery);
  
  if (!remainingSnapshot.empty) {
    const newHostId = remainingSnapshot.docs[0].id;
    await updateDoc(doc(getRoomsCollection(), roomId), {
      hostId: newHostId,
    });
  }
}
```

#### 修正後のコード:
```javascript
// ✅ シンプル: 参加者を削除するだけ
const leaveRoom = async () => {
  if (myParticipantId) {
    await deleteDoc(doc(getRoomsCollection(), roomId, "participants", myParticipantId));
    localStorage.removeItem(`participantId_${roomId}`);
    setMyParticipantId(null);
  }
};
```

**削減されたコード行数**: 約50行

---

### 2. **RoomHeader.jsx のUI変更**

#### 変更前:
```javascript
// ❌ 全員に退出ボタン + ホストに終了ボタン
<button onClick={onLeaveRoom}>ルーム一覧に戻る</button>  // 全員
{isHost && <button onClick={onEndRoom}>部屋を終了</button>}  // ホストのみ
```

#### 変更後:
```javascript
// ✅ ゲストには退出ボタンのみ、ホストには終了ボタンのみ
{!isHost && <button onClick={onLeaveRoom}>ルーム一覧に戻る</button>}  // ゲストのみ
{isHost && <button onClick={onEndRoom}>部屋を終了</button>}  // ホストのみ
```

---

## 📝 仕様の変更

### **ホスト権限の仕様**

| 項目 | 変更前 | 変更後 |
|-----|-------|-------|
| ホストの決定 | 最初の参加者 | 部屋作成者（固定） |
| ホスト退出時 | 次の参加者に自動移譲 | hostId を保持（移譲しない） |
| ホスト再入室時 | 新しいゲストとして入室 | hostId が一致すればホストに復帰 |
| ホスト不在の部屋 | - | 削除できないが、許容 |

### **UIの変更**

| ユーザー | 表示されるボタン | 動作 |
|---------|---------------|------|
| ゲスト | 「ルーム一覧に戻る」のみ | 参加者リストから削除してホームに戻る |
| ホスト | 「部屋を終了」のみ | 部屋を削除してホームに戻る |

---

## 🐛 修正されたバグ

### **観測されていたバグ**
```
3人が部屋にアクセス（A=ホスト、B・C=ゲスト）
↓
Aが退出
↓
❌ B・Cのどちらにも権限が移らず、ホストがいない状態に
↓
Aが再入室
↓
❌ Aもゲストになり、3人ともゲスト状態に
↓
誰も部屋を閉じることができなくなる
```

### **修正後の動作**
```
3人が部屋にアクセス（A=ホスト、B・C=ゲスト）
↓
Aが退出
↓
✅ hostId は "A_ID" のまま保持
✅ B・Cはゲストのまま（権限移譲しない）
↓
Aが再入室
↓
✅ Aのホスト権限が復活（hostId が一致するため）
```

---

## ✅ メリット

### 1. **シンプルさ**
- 複雑な権限移譲ロジックを削除
- コードが約50行削減
- 理解しやすく、保守しやすい

### 2. **予測可能性**
- 部屋作成者が永続的にホスト
- 意図しない権限移動が起きない
- ユーザーが混乱しない

### 3. **バグの削減**
- 権限移譲に関するバグを根本的に解決
- エッジケースが少ない
- テストが容易

---

## ⚠️ 注意点・制限事項

### **1. ホスト不在の部屋**

**状況**: ホストが退出すると、部屋を削除できる人がいなくなる

**対処法**:
- ✅ ホストが再入室すれば、再びホスト権限を持つ
- ✅ 使われなくなった部屋は自然に放置される
- ✅ 管理者がFirestoreから手動で削除できる

### **2. ホスト権限の移譲不可**

**状況**: ホストが権限を他の人に渡すことができない

**対処法**:
- 将来的に手動移譲機能を追加する可能性あり
- 現時点では、新しい部屋を作り直すことで対応

---

## 📂 更新されたファイル

### **コード**
1. ✅ `src/features/collaboration/hooks/useParticipants.js`
   - ホスト権限移譲ロジックを削除
   - `leaveRoom` 関数を簡略化
   - クリーンアップ処理を簡略化

2. ✅ `src/features/study-room/components/RoomHeader.jsx`
   - ゲスト: 「ルーム一覧に戻る」ボタンのみ表示
   - ホスト: 「部屋を終了」ボタンのみ表示

### **ドキュメント**
1. ✅ `docs/bugs.md`
   - ホスト権限移譲を「未実装（設計変更）」に更新

2. ✅ `src/features/study-room/README.md`
   - v1.3.0 の変更履歴を追加
   - 修正されたバグのセクションを更新

3. ✅ `docs/refactoring-summary.md`
   - 最新の設計変更を追加

4. ✅ `docs/host-permission-spec.md` **（新規作成）**
   - ホスト権限の仕様を詳細に記載
   - よくある質問を追加
   - 将来的な拡張案を記載

5. ❌ `docs/test-scenarios.md` **（削除）**
   - ホスト権限移譲のテストシナリオは不要になったため削除

---

## 🧪 テスト項目

### **動作確認**
- [ ] ホストが「部屋を終了」ボタンで部屋を削除できる
- [ ] ゲストが「ルーム一覧に戻る」ボタンで退出できる
- [ ] ホストが退出しても hostId が保持される
- [ ] ホストが再入室するとホスト権限が復活する
- [ ] ゲストにはホストのボタンが表示されない

### **エッジケース**
- [ ] ホストが不在の部屋でもゲストは入室できる
- [ ] ホスト不在の部屋では誰も部屋を削除できない
- [ ] 複数ユーザーが同時に退出してもエラーが発生しない

---

## 🚀 デプロイ手順

### **1. コードの確認**
```bash
# リンターエラーがないことを確認
npm run lint

# ビルドが成功することを確認
npm run build:prod
```

### **2. テスト**
```bash
# ローカル環境でテスト
npm run dev

# 動作確認
# - ホスト/ゲストのボタン表示
# - ホスト退出・再入室の動作
```

### **3. デプロイ**
```bash
# 開発環境にデプロイ
npm run deploy:dev

# 問題なければ本番環境にデプロイ
npm run deploy:prod
```

---

## 📊 影響範囲

### **影響を受けるユーザー**
- ✅ すべてのユーザー（UI変更のため）

### **影響を受ける機能**
- ✅ ルーム退出機能
- ✅ ルーム終了機能
- ✅ ホスト権限の判定

### **影響を受けないもの**
- ✅ タイマー機能
- ✅ ビデオ通話機能
- ✅ ゲーム機能
- ✅ 参加者リスト表示

---

## 🔮 将来の拡張案

### **1. 手動でのホスト権限移譲**
ホストが明示的に権限を他のユーザーに移譲できる機能

**実装イメージ:**
```javascript
// ホストコントロールに追加
<button onClick={() => transferHost(selectedUserId)}>
  ホスト権限を移譲
</button>
```

### **2. 部屋の有効期限**
一定時間経過した部屋を自動削除する機能

**実装イメージ:**
```javascript
// Cloud Functions で定期的に実行
const deleteExpiredRooms = async () => {
  // 24時間以上前に作成された部屋を削除
};
```

### **3. 複数ホスト機能**
複数のユーザーがホスト権限を持てる機能

**実装イメージ:**
```javascript
// room.hostIds: ["user1", "user2", "user3"]
const isHost = room?.hostIds?.includes(myParticipantId);
```

---

## 📞 問い合わせ

質問や問題がある場合は、開発チームまでご連絡ください。

---

**承認者**: 開発チーム  
**レビュー**: ✅ 完了  
**ステータス**: 🚀 デプロイ準備完了

