# 修正すべきバグ一覧

- [ ] 機能ごとにコンポーネントにわける
- [ ] いらんコード削除する
- [ ] 保守しやすいアーキテクチャ
    - [ ] フォルダ構成
- [ ] やばいコード一旦整理してどこが問題か調べる
    - [ ] 依存関係可視化ツール使う　js ts
- [ ] ホスト付与のロジックを修正することにより、ホスト権限が移動するバグを修正(現在のロジックは、入った人間のシリアル番号0番目をホストとしている)
- [ ] 部屋の人数制限のロジック(今は、機能していない)
- [ ] 部屋退出時の動向(人数管理がうまくいっていない。シリアル)
- [ ] ホスト以外が部屋削除できちゃう

---

## バグの原因と解決プラン

### 1. ホスト権限が移動するバグ
- **原因**: サーバーサイドに明確なホスト管理機能が存在せず、クライアントが暗黙的に最初の参加者をホストと見なしているため。ホストが退出した際の権限移譲ロジックが欠如している。
- **解決プラン**:
    1. `room` の状態に `hostId` を追加する。
    2. 最初のプレイヤーが参加した際に、その `playerId` を `hostId` として設定する。
    3. プレイヤーが退出する際、そのプレイヤーがホストだった場合は、残っているプレイヤーの中から新しいホストを選出し（例：参加が早い順）、`hostId` を更新する。
    4. ホスト情報が変更されたことを全クライアントに通知する。

### 2. 部屋の人数制限のロジック
- **原因**: 新しいプレイヤーを追加する `addPlayer` 関数に、現在の参加者数と部屋の最大人数を比較するチェックが存在しない。
- **解決プラン**:
    1. 部屋の状態に最大人数 (`maxPlayers`) を設定する（例：8人）。
    2. `addPlayer` 関数の処理の冒頭で、現在のプレイヤー数が `maxPlayers` に達していないかを確認する。
    3. 上限に達している場合は、プレイヤーの追加を拒否し、その旨をクライアントに通知する。

### 3. 部屋退出時の動向
- **原因**: プレイヤー退出処理 (`removePlayer`) が、プレイヤーをリストから削除するだけで、ホスト権限の移譲や、最新の参加者リストのブロードキャストなど、状態を同期するための付随処理が不足している。
- **解決プラン**:
    1. `removePlayer` 処理後に、最新のプレイヤーリストを部屋にいる全クライアントにブロードキャストする。
    2. ホストが退出した場合の権限移譲ロジックを実装する（上記1と連動）。

### 4. ホスト以外が部屋削除できちゃう
- **原因**: 部屋の削除操作がサーバーサイドの権限チェックを経ておらず、クライアントが直接データベース（Firestore）を操作している可能性が高い。
- **解決プラン**:
    1. WebSocketメッセージに `deleteRoom` のようなタイプを新たに追加する。
    2. サーバーは `deleteRoom` メッセージを受け取ったら、メッセージを送信したプレイヤーがその部屋のホストであるか (`hostId` と一致するか) を検証する。
    3. ホストであることが確認できた場合のみ、部屋の削除処理を実行する。
    4. ホストでない場合は、操作を拒否するエラーメッセージをクライアントに返す。
