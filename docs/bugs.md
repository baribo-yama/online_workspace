# 修正すべきバグ一覧

- [ ] 機能ごとにコンポーネントにわける
- [ ] いらんコード削除する
- [ ] 保守しやすいアーキテクチャ
    - [ ] フォルダ構成
- [ ] やばいコード一旦整理してどこが問題か調べる
    - [ ] 依存関係可視化ツール使う　js ts
- [ ] ~~ホスト付与のロジックを修正することにより、ホスト権限が移動するバグを修正~~ → **未実装（設計変更により対応しない）**
- [ ] 部屋の人数制限のロジック(今は、機能していない)
- [ ] 部屋退出時の動向(人数管理がうまくいっていない。シリアル)
- [ ] ホスト以外が部屋削除できちゃう
- [x] 参加者リストに名前が反映されないことがある ✅ **修正完了 (v1.3.1 / 2025-10-17)**

---

## バグの原因と解決プラン

### 1. ホスト権限が移動するバグ → **未実装（設計変更）**
- **原因**: ホスト権限の自動移譲はバグの温床となるため、実装しない設計判断
- **現在の仕様**:
    1. ✅ 部屋を作成した人が永続的にホスト（`hostId` に記録）
    2. ✅ ホストが退出しても `hostId` は保持される（権限移譲しない）
    3. ✅ ホストが再入室した場合、`hostId` が一致すればホスト権限を維持
    4. ❌ ホストが不在の場合、部屋を削除できる人がいなくなる（許容）
- **UI仕様**:
    - ホスト: 「部屋を終了」ボタンのみ表示
    - ゲスト: 「ルーム一覧に戻る」ボタンのみ表示
- **運用**:
    - ホストが不在の部屋は自然に使われなくなる
    - または管理者が手動で削除する

### 2. 部屋の人数制限のロジック
- **原因**: 新しいプレイヤーを追加する `addPlayer` 関数に、現在の参加者数と部屋の最大人数を比較するチェックが存在しない。
- **解決プラン**:
    1. 部屋の状態に最大人数 (`maxPlayers`) を設定する（例：8人）。
    2. `addPlayer` 関数の処理の冒頭で、現在のプレイヤー数が `maxPlayers` に達していないかを確認する。
    3. 上限に達している場合は、プレイヤーの追加を拒否し、その旨をクライアントに通知する。

### 3. 部屋退出時の動向
- **原因**: プレイヤー退出処理 (`removePlayer`) が、プレイヤーをリストから削除するだけで、ホスト権限の移譲や、最新の参加者リストのブロードキャストなど、状態を同期するための付随処理が不足している。
- **解決プラン**:
    1. `removePlayer` 処理後に、最新のプレイヤーリストを部屋にいる全クライアントにブロードキャストする。
    2. ホストが退出した場合の権限移譲ロジックを実装する（上記1と連動）。

### 4. ホスト以外が部屋削除できちゃう
- **原因**: 部屋の削除操作がサーバーサイドの権限チェックを経ておらず、クライアントが直接データベース（Firestore）を操作している可能性が高い。
- **解決プラン**:
    1. WebSocketメッセージに `deleteRoom` のようなタイプを新たに追加する。
    2. サーバーは `deleteRoom` メッセージを受け取ったら、メッセージを送信したプレイヤーがその部屋のホストであるか (`hostId` と一致するか) を検証する。
    3. ホストであることが確認できた場合のみ、部屋の削除処理を実行する。
    4. ホストでない場合は、操作を拒否するエラーメッセージをクライアントに返す。

### 5. 参加者リストに名前が反映されないことがある ✅ **修正完了 (v1.3.1)**
- **原因**: 重複削除処理の競合状態（Race Condition）により、削除完了前に新規参加者が追加されていた。
- **解決内容**:
    1. ✅ 重複削除処理を`Promise.all`で並列実行し、完了を待機
    2. ✅ 削除完了後に参加者数を再確認してホスト判定を正確化
    3. ✅ onSnapshot内の重複削除も一括処理に変更
    4. ✅ 古い参加者の削除も一括処理に変更
- **修正箇所**: `src/features/collaboration/hooks/useParticipants.js`
- **詳細**: [bugfix-v1.3.1.md](./bugfix-v1.3.1.md)
