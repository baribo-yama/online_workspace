# AI_GUIDELINES — MOKU

## 目的
このドキュメントは、AI支援開発を効果的に行うためのガイドラインを提供します。  
AI（Cursor、ChatGPT、GitHub Copilot等）を使用する際の指示方法、期待する動作、レポート作成方法を定義します。

**関連ドキュメント:**
- [TEAM_DEVELOPMENT.md](./TEAM_DEVELOPMENT.md) - チーム開発ガイド（Firebase Hostingの注意点など）
- [ARCHITECTURE.md](./ARCHITECTURE.md) - アーキテクチャ設計方針
- [tech-stack.md](./tech-stack.md) - 技術スタック詳細

---

## AI利用の基本方針

### **1. ドキュメントファーストアプローチ**
AI に作業を依頼する際は、必ず関連するドキュメントを参照させる。

**推奨する指示例:**
```
@docs/ARCHITECTURE.md @docs/CODING_RULES.md を参照して、
@src/features/study-room/components/home/RoomCard.jsx を
UIとロジックを分離する形でリファクタリングしてください。
```

### **2. 段階的な変更**
大規模な変更は段階的に進める。各フェーズで動作確認を行う。

**悪い例:**
```
study-room 機能全体をTypeScriptに変換してください。
```

**良い例:**
```
Phase 1: constants/ フォルダのみをTypeScriptに変換してください。
その後、動作確認を行います。
```

### **3. 既存コードの保持**
リファクタリング時は、既存の動作を変更しない。

**必須条件:**
- 関数の呼び出し順序を維持
- バグを混入させない
- 既存のテストが通る状態を維持

---

## リファクタリング時の必須タスク

### **📝 リファクタリングレポートの作成**

**重要:** リファクタリング作業を完了した際は、必ず以下のレポートを作成すること。

#### **レポート作成場所**
```
docs/refactoring-reports/YYYY-MM-DD_feature-name_description.md
```

#### **レポートテンプレート**
`docs/templates/REFACTORING_REPORT.md` を使用すること。

#### **レポートに含めるべき内容**
1. **作業概要** - 何をリファクタリングしたか
2. **変更サマリー** - 作成/変更/削除されたファイル一覧
3. **ビフォー・アフター比較** - コード行数、ファイル数、構造の変化
4. **改善点** - 保守性、パフォーマンス、テスト容易性などの向上
5. **影響範囲** - 変更が影響する範囲
6. **動作確認** - ビルド成功、linter通過、手動テスト結果
7. **今後の課題** - 残された課題や次のステップ

#### **レポート作成タイミング**
- ✅ 大規模リファクタリング完了時（必須）
- ✅ フォルダ構成変更時（必須）
- ✅ 複数ファイルに影響する変更時（推奨）
- ❌ 軽微なバグ修正（不要）
- ❌ コメント追加のみ（不要）

---

## AI への指示例集

### **リファクタリング指示**

#### **パターン1: コンポーネント分割**
```
@docs/ARCHITECTURE.md の原則に従って、
@src/features/study-room/components/home/HomePage.jsx を
以下の基準で分割してください：

1. 50行以上の独立したUIは別コンポーネントに
2. UIとロジックを分離（hooksへ）
3. 既存の動作を維持
4. 完了後、リファクタリングレポートを作成
```

#### **パターン2: hooks 分離**
```
@src/features/study-room/components/room/RoomPage.jsx から
権限チェックロジックを hooks/room/useRoomPermissions.js に抽出してください。

条件:
- 既存の isHost, canStartGame, gameStatus の計算を移行
- useMemo でメモ化
- RoomPage の動作を変更しない
```

#### **パターン3: 定数の一元管理**
```
@src/features/study-room/ 内の全てのマジックナンバーとマジックストリングを
constants/ フォルダに移動してください。

手順:
1. 既存のマジックナンバー/ストリングを特定
2. constants/ にカテゴリ別ファイルを作成
3. 全ての参照を更新
4. リファクタリングレポートを作成
```

### **機能追加指示**

#### **パターン1: 新機能追加**
```
@docs/ARCHITECTURE.md の feature-based architecture に従って、
チャット機能を新規作成してください。

構成:
- src/features/chat/
  - components/
  - hooks/
  - constants/
  - utils/
- README.md を含める
- 既存機能に影響を与えない
```

#### **パターン2: 既存機能への統合**
```
@src/features/study-room/components/room/RoomPage.jsx に
@src/features/chat/ のチャット機能を統合してください。

条件:
- 既存のレイアウトを崩さない
- 遅延読み込みを使用
- エラーハンドリングを実装
```

### **バグ修正指示**

```
@docs/bugs.md の [BUG-001] を修正してください。

条件:
- 根本原因を特定
- 最小限の変更で修正
- 再発防止策を README.md に記載
- 他の機能に影響しないこと
```

---

## AI への期待する動作

### **✅ AI がすべきこと**

1. **ドキュメント参照**
   - ARCHITECTURE.md の原則を守る
   - CODING_RULES.md の規約に従う
   - 既存の README.md を確認

2. **段階的な作業**
   - TODOリストを作成
   - フェーズごとに進捗を報告
   - 各フェーズで動作確認

3. **品質保証**
   - linter エラーをチェック
   - ビルドが成功することを確認
   - 既存のテストを実行

4. **ドキュメント更新**
   - README.md を更新
   - CHANGELOG.md に記録
   - リファクタリングレポート作成

5. **明確なコミュニケーション**
   - 何を変更したか明示
   - なぜ変更したか説明
   - 影響範囲を報告

### **❌ AI がしてはいけないこと**

1. **無断での大規模変更**
   - 指示されていない範囲の変更
   - 既存の動作を変更
   - ドキュメントなしの構造変更

2. **品質を犠牲にした変更**
   - linter エラーを残す
   - ビルドエラーを無視
   - テストを削除

3. **不完全な作業**
   - ドキュメントを更新しない
   - レポートを作成しない
   - TODO を未完了のまま終了

---

## リファクタリング完了チェックリスト

リファクタリング作業を完了する前に、以下を確認すること：

### **📋 必須チェック項目**

- [ ] **動作確認**
  - [ ] `npm run dev` でアプリが起動する
  - [ ] 変更した機能が正常に動作する
  - [ ] 既存機能に影響がない

- [ ] **コード品質**
  - [ ] `npm run lint` でエラーがない
  - [ ] ビルドが成功する (`npm run build:dev`)
  - [ ] コンソールエラーがない

- [ ] **ドキュメント更新**
  - [ ] README.md を更新（該当する場合）
  - [ ] CHANGELOG.md に記録（該当する場合）
  - [ ] **リファクタリングレポートを作成**（必須）

- [ ] **ファイル整理**
  - [ ] 古いファイルを削除
  - [ ] index.js を更新
  - [ ] インポートパスを修正

- [ ] **Git 管理**
  - [ ] 適切なコミットメッセージ
  - [ ] 変更内容が明確
  - [ ] 不要なファイルを除外

---

## レポート作成の詳細手順

### **1. テンプレートをコピー**

```bash
cp docs/templates/REFACTORING_REPORT.md docs/refactoring-reports/2025-10-19_study-room_level2-refactoring.md
```

### **2. レポートを埋める**

テンプレートの各セクションを埋める。

**重要な数値:**
- ビフォー・アフターのファイル数
- 平均行数の変化
- 削減された行数
- 改善率（パーセンテージ）

**重要な説明:**
- なぜリファクタリングしたか
- どのように改善されたか
- 今後の展望

### **3. レポートを docs/refactoring-reports/ に保存**

```
docs/refactoring-reports/
├── 2025-10-19_study-room_level2-refactoring.md
├── 2025-10-XX_video-call_optimization.md
└── ...
```

### **4. PROJECT_OVERVIEW.md にリンクを追加**

プロジェクト概要に最新のリファクタリング情報を追記。

---

## AI への標準的な指示テンプレート

### **大規模リファクタリング**

```
【タスク】
@src/features/[feature-name]/ をレベル2構成にリファクタリング

【参照ドキュメント】
@docs/ARCHITECTURE.md
@docs/CODING_RULES.md
@src/features/study-room/README.md (参考例)

【条件】
1. UIとロジックを分離
2. コンポーネントを機能別に分割
3. hooks をカテゴリ別に整理
4. constants を分割
5. utils を作成（必要に応じて）
6. 既存の動作を変更しない
7. バグを混入させない

【完了時の必須タスク】
1. ビルド確認
2. linter 確認
3. 動作確認（手動テスト）
4. リファクタリングレポート作成
5. README.md 更新
6. CHANGELOG.md 更新
```

### **小規模な改善**

```
【タスク】
[具体的な改善内容]

【参照】
@docs/CODING_RULES.md

【条件】
- 既存の動作を維持
- linter エラーを残さない

【完了時】
- 動作確認
- ドキュメント更新（必要に応じて）
```

---

## よくある質問（FAQ）

### **Q1: いつリファクタリングレポートを作成すべきですか？**

**A:** 以下の場合に必須です：
- フォルダ構成の変更
- 10ファイル以上に影響する変更
- アーキテクチャの変更
- 大幅なコード削減

### **Q2: レポートはどこに保存しますか？**

**A:** `docs/refactoring-reports/YYYY-MM-DD_feature-name_description.md`

### **Q3: リファクタリング中にバグを見つけたらどうしますか？**

**A:** 
1. リファクタリングを一時停止
2. バグを docs/bugs.md に記録
3. バグ修正を優先（または別タスクとして分離）
4. リファクタリングを再開

### **Q4: AI が指示通りに動作しない場合は？**

**A:**
1. 指示を明確にする（具体的なファイルパスを含める）
2. 参照ドキュメントを明示する
3. 段階的な指示に分割する

---

## 更新履歴

- **2025-10-19**: 初版作成（平林）
  - リファクタリングレポート作成の義務化
  - AI への指示例を追加
  - チェックリストを整備

---

## 関連ドキュメント

- [ARCHITECTURE.md](./ARCHITECTURE.md) - アーキテクチャ設計
- [CODING_RULES.md](./CODING_RULES.md) - コーディング規約
- [templates/REFACTORING_REPORT.md](./templates/REFACTORING_REPORT.md) - レポートテンプレート

