# Expected Spec（確定している追加／変更仕様）

本ドキュメントは MOKU の今後実装が確定している仕様のみを記載する。  
優先度・実装手順は含めない（別ドキュメントで管理）。

---

## 1) ホストが「終了せずに退出」する機能

- **条件**  
　現在のホストが、部屋を終了させずにルームから離脱したい操作を行った場合
- **挙動**  
　ホストは「ルーム一覧に戻る」などの操作により退出可能とする  
　その際、ホスト権限の移譲処理を実行する（＝入室順最古ユーザーを新ホストへ）
- **例外**  
　残存参加者が0人の場合は部屋を終了させる（= 権限移譲は発生しない）
- **優先順位**  
　ホストが明示的に退出操作を行った場合は、自動終了よりも優先してこの処理を実行する

### 1-1) ホスト退出時のボタン配置

- **UI レイアウト**  
　ホストの画面には2つのボタンが並ぶ：
  - 左側：「ルーム一覧に戻る」（権限移譲して退出）
  - 右側：「ルームを終了する」（部屋を削除）
- **ゲストの画面**  
　「ルーム一覧に戻る」ボタン（権限移譲なし）

### 1-2) 入室順序の記録方法

- **joinedAt フィールド**  
　各参加者ドキュメントに `joinedAt: serverTimestamp()` を記録  
　ホスト退出時の権限移譲対象の判定に使用
- **複数タブからの同じユーザーの入室**  
　同じ名前の参加者ドキュメントが複数存在しないよう制御  
　Firestore で同じ名前の参加者を検索し、既存ドキュメントを再利用

### 1-3) 権限移譲時の UI フィードバック

- **旧ホスト（退出するホスト）**  
　トースト通知：「ホスト権限を移譲しました」（3秒後に自動消滅）
- **新ホスト（権限を受け取るゲスト）**  
　バナー表示：「⭐ あなたはこのルームのホストになりました」  
　（数秒後に自動消滅、閉じるボタンでも消せる）

### 1-4) 残り1人の場合の処理

- **挙動**  
　残存参加者が1人の場合、その人を新ホストに昇格させる  
　部屋は継続（削除しない）
- **新ホストの権限**  
　タイマーの操作が可能

### 1-5) 同じ joinedAt の場合の判定基準

- **優先順序**  
　`doc.id` の辞書順（アルファベット順）
- **理由**  
　Firestore が自動生成する `doc.id` は一意かつ決定的

### 1-6) 権限移譲の実装パターン

- **トランザクション使用**  
　権限移譲は Firestore トランザクションで実行  
　新ホストの `isHost` 更新と旧ホストの参加者削除を1セットで実行  
  - 両方成功 → 確定
  - いずれか失敗 → ロールバック（元の状態に戻す）
- **エラー時の処理**  
　トランザクション失敗時はユーザーにエラーメッセージを表示  
　ホストはルームに留まり、再度操作可能

---

## 2) ホスト退出時の権限移譲

- **条件**  
　現在のホストが「ルームを終了せずに退出」した場合
- **挙動**  
　入室順序が最も早い参加者を新しいホストとして再割当する
- **例外**  
　残存参加者が0人の場合、部屋は終了させる

---

## 3) ルーム終了に関する仕様

### 3-1) 無人ルーム自動終了（将来実装予定）
- **目的**: バグで無人ルームが残存した場合の自動削除
- **条件**: ルーム内の参加者数が 0 の状態が **10分** 継続した場合
- **挙動**: ルームを終了する（Firestore上から削除／LiveKitも終了）
- **例外**: 終了前に新たな参加者が入室した場合、この終了処理は無効化される
- **実装状況**: 未実装（将来のバグフォールバック機能として予定）

### 3-2) ホスト確認による自動終了（★実装済み）
- **目的**: 定期的にホストの存在確認を行い、参加者が長時間待たされることを防止
- **条件**:
  - ルーム作成時から **2時間ごと（Constants: ROOM_CHECK_INTERVAL_MS）** に定期的に通知
  - アプリへの操作の有無に関係なく、時間ベースで通知を実施
  - 参加者が1人（ホストのみ）の場合でも適用する
- **通知タイミング**:
  - ルームの `createdAt` を基準に、2時間経過ごとに自動通知
  - 例：ルーム作成が10:00 → 12:00, 14:00, 16:00...に通知
  - `lastActivity` の更新は不要（操作状況を監視しない）
- **確認トースト表示**:
  - 対象: ホストのみ
  - 表示内容: 「起きてますか？」+ 「はい」ボタン
  - 表示位置: 画面中央上部
  - 表示時間: **10分間（Constants: CONFIRMATION_TOAST_DURATION_MS）**（自動非表示なし、閉じるボタンなし）
  - 表示タイミング: 2時間経過ごとに自動表示
  - 他のトーストとの関係: 併用可能（複数のトーストが同時に表示される可能性あり）
- **応答ボタン**:
  - 「はい」ボタンクリック → トースト非表示
  - 次の通知は再度2時間後に自動表示
- **自動終了**:
  - トースト表示から **10分以内** に応答なし → ルーム自動終了
  - 終了処理: Firestore削除 + LiveKit切断 + 全参加者をホーム画面へ自動遷移
- **実装対象参加者数**:
  - 1人以上（参加者がホストのみでも適用）
- **Constants管理**:
  - `src/features/study-room/constants/limits.js` の `HOST_INACTIVITY_CONFIG` で管理
  - 開発者はConstantsファイルで時間設定を自由に変更可能
- **実装構成**:
  - `components/room/InactivityConfirmationToast.jsx` - トースト表示コンポーネント（UI専用）
  - `hooks/room/useHostInactivity.js` - 定期通知・検知・終了処理ロジック
  - `constants/limits.js` - 時間設定定数
- **実装方針**:
  - ルームの `createdAt` を監視して定期通知（Firestore更新不要）
  - クライアント側の操作監視は実装しない

### 3-3) 全体ルール
- 上記 3-2 のみが成立した時点で終了処理を実行する

---

## 5) 入室時のカメラ・マイクデフォルト設定

- **条件**  
　ユーザーがルームに入室する際
- **挙動**  
　デフォルト設定として、カメラはOFF、マイクはONで入室する  
　入室後、ユーザーはルーム内で任意のタイミングでカメラ・マイクを手動で変更可能
- **例外**  
　ブラウザ権限が拒否されている場合はマイクもOFFとなる  
　この場合、マイク有効化には「ブラウザのマイク権限を許可してください」という案内を表示

---

## 6) ルーム内チャット機能

- **条件**  
　ユーザーがルームに入室している間
- **挙動**  
　同一ルーム参加者全員に対してテキストメッセージを送受信できる  
　（チャットはルーム全体チャットのみ。個別・DMは対象外）
- **例外**  
　チャット履歴はルーム終了時に消去される（退出後に履歴は参照不可）

---


## 7) エンタメ機能：ランダム話題ボード（休憩中のみ表示）

- **条件**  
　ポモドーロタイマーが「休憩状態」である間
- **挙動**  
　タイマー下部に話題を1件表示する  
　表示された話題は休憩終了まで固定（途中で更新しない）
- **例外**  
　ポモドーロが「集中状態」に戻った時点で話題表示は非表示に戻す

---

## 8) カメラ背景ぼかし

- **条件**  
　ユーザーのカメラ映像がルーム内に送信されている場合  
　（ユーザー個人単位でON/OFF設定可能）
- **挙動**  
　ユーザーは任意のタイミングで背景ぼかしのON/OFFを切り替えられる  
　ONにした場合は人物以外の背景領域をぼかして表示する
- **例外**  
　端末性能不足またはブラウザ非対応の場合は  
　「背景ぼかしはご利用の環境では使用できません」という案内を表示し  
　代替映像（通常映像）の表示は行わない

---

## 9) 一部屋あたりの参加人数上限（constants管理）

- **条件**  
　ユーザーが部屋へ入室しようとした時点
- **挙動**  
　参加人数が上限値に達している場合は入室を拒否し  
　「この部屋は満員です」などのメッセージを表示する
- **例外**  
　上限値そのものは UI から変更不可とし、constants 等で開発者のみが変更可能とする  
　（Expected Spec として具体的な数値は固定しない）

---

## 10) ルームタイトル編集（ホストのみ）

- **条件**  
　ホストがルームに在室している間
- **挙動**  
　ホストは任意のタイミングでルームタイトルを編集できる  
　編集結果は即時に全参加者へ反映され、同時にホーム画面のルーム一覧表示のタイトルも更新される
- **例外**  
　ゲストはタイトル編集を行えない

---

（以上）
